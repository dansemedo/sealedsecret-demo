# sealedsecret-demo
A Demo Project to test sealed secret in AKS, this project includes the Terraform files to generate the infrastructure and a .NET CORE application with HELM and a Sealed Secret in JSON format and the original one for you to run against KUBESEAL.

## Getting Started

0. To run this demo you will need:
  - An Azure Subscription
  - Terraform configured and installed 
  - Visual Studio Code (nice to have)
  - .NET CORE 2.2 / 2.1
  - HELM installed on AKS
  - Azure DevOps to automate the build/deploy of your test environment
  
1. Create and Azure DevOps repository/GitHub and push this repository to yours.
  
2. Clone this repository and open the IAAC/terraform folder (We will create the AKS (Azure Kubernetes Services), ACR (Azure Container Registry) and EventHub on Azure using Terraform).

3. Fill the values on the terraform.tfvars and secrets.tfvars (I am using secrets.tfvars to be blocked by gitignore).

4. Run the commands:

```code
  - terraform plan -var-file="secrets.tfvars" -var-file="terraform.tfvars" -auto-approve  #(This will test if your code is OK and What componentes will build in Azure).
  - terraform apply -var-file="secrets.tfvars" -var-file="terraform.tfvars" -auto-approve #(This will build the resources on Azure)
 ```
 Check if all the resources on Azure were created successfully.
 
5. Open the Calculator solution project (.sln) on Visual Studio 2019.
 
6. Build all the applications and check if They are running and building correctly (this project uses .NET CORE 2.2 this installed together with Visual Studio 2019).
 
7. Check the Charts folder, this is a HELM chart and you will use this to deploy the demo container to your environment.
 
8. Check the Dockerfiles, you will use this file to push your container to container registry.
 
9. Go to Azure DevOps, create a build pipeline and use the file azure-pipelines.yml in the calculator project folder
 
10. Go to Release pipeline in Azure DevOps and create the Release steps (see the picture below about how to create everything).
![alt text](https://github.com/dansemedo/sealedsecret-demo/docs/releasepipeline.png "Azure DevOps Release Pipeline")
  
11. Follow the instructions on https://github.com/bitnami-labs/sealed-secrets to configure your Sealed Secret controller in you AKS Cluster and KUBESEAL in your local machine/Azure DevOps agent if you wish.

12. Go to the folder IAAC/secrets and copy the secret-original.yaml to your local environment, You will use this file to fill the correct informations about Event Hub (Event Hub Namespace, Connection String and Namespace you want to create the secrets in AKS).

13. Replace the secrets.JSON in the calculator.webapi from the new one generated by you using the KUBESEAL command.

14. Push the changes to the repository, wait for the CI/CD of the Azure DevOps run and you should have everything working fine. If something is not working, check again if you created the secret in the right namespace or the Kubeseal controller is installed correctly. You should see: kube-system   sealed-secrets-controller-6b9f699f5-zhvw5   1/1

